<!DOCTYPE html>
<html>
<head>
<title>BAO_CAO_THIET_KE_HE_THONG.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="b%C3%A1o-c%C3%A1o-thi%E1%BA%BFt-k%E1%BA%BF-h%E1%BB%87-th%E1%BB%91ng-smart-classroom-iot">B√ÅO C√ÅO THI·∫æT K·∫æ H·ªÜ TH·ªêNG SMART CLASSROOM IoT</h1>
<blockquote>
<p><strong>H·ªá th·ªëng gi√°m s√°t v√† ƒëi·ªÅu khi·ªÉn l·ªõp h·ªçc th√¥ng minh</strong><br>
T√≠ch h·ª£p ESP32, MQTT Gateway, Backend API, v√† Web Dashboard</p>
</blockquote>
<hr>
<h2 id="3-thi%E1%BA%BFt-k%E1%BA%BF-h%E1%BB%87-th%E1%BB%91ng">3. Thi·∫øt K·∫ø H·ªá Th·ªëng</h2>
<h3 id="31-s%C6%A1-%C4%91%E1%BB%93-kh%E1%BB%91i-t%E1%BB%95ng-th%E1%BB%83">3.1. S∆° ƒê·ªì Kh·ªëi T·ªïng Th·ªÉ</h3>
<p>H·ªá th·ªëng Smart Classroom bao g·ªìm 4 th√†nh ph·∫ßn ch√≠nh:</p>
<pre><code class="language-mermaid"><div class="mermaid">graph TB
    subgraph ESP32["üîß ESP32 YoloUNO (FreeRTOS)"]
        direction TB
        SENSORS["üìä Sensors<br/>DHT20 Temperature/Humidity<br/>GL5528 Light Sensor<br/>PIR AS312 Motion"]
        DEVICES["‚öôÔ∏è Actuators<br/>Fan (PWM GPIO2)<br/>Light (PWM GPIO3)"]
        TASKS["üîÑ FreeRTOS Tasks<br/>temp_humi_monitor<br/>light_sensor_monitor<br/>pir_sensor_monitor<br/>gateway_task<br/>main_server_task<br/>device_control"]
        
        SENSORS --> TASKS
        TASKS --> DEVICES
    end
    
    subgraph GATEWAY["üåâ Python MQTT Gateway"]
        BROKER["üì° MQTT Broker<br/>Port: 1883<br/>hbmqtt"]
        SUB["üì• MQTT Subscriber<br/>Topic: yolouno/sensor"]
        PUB["üì§ MQTT Publisher<br/>Topics: yolouno/command<br/>yolouno/wifi"]
        SSE_CLIENT["üîå Backend SSE Client<br/>Receives commands"]
        
        BROKER --> SUB
        BROKER --> PUB
    end
    
    subgraph BACKEND["üñ•Ô∏è Backend Server (Node.js)"]
        API["üîó Express API<br/>Port: 3000"]
        DB["üíæ MongoDB"]
        SSE_STREAM["üì° SSE Streaming<br/>commandStream<br/>sensorStream"]
        
        API --> DB
        API --> SSE_STREAM
    end
    
    subgraph FRONTEND["üåê Web Frontend (React)"]
        DASHBOARD["üìä Dashboard<br/>Real-time Charts"]
        CONTROL["üéõÔ∏è Device Control Panel"]
        CONFIG["‚öôÔ∏è Configuration<br/>WiFi, Interval"]
        
        DASHBOARD --> CONTROL
        CONTROL --> CONFIG
    end
    
    ESP32 -->|"MQTT Publish<br/>yolouno/sensor<br/>(JSON)"| BROKER
    BROKER -->|Subscribe| SUB
    SUB -->|"HTTP POST<br/>/api/iot/sensor"| API
    
    API -->|"SSE Stream<br/>/api/iot/commandStream"| SSE_CLIENT
    SSE_CLIENT -->|"MQTT Publish<br/>yolouno/command"| PUB
    PUB -->|Subscribe| ESP32
    
    FRONTEND -->|"HTTP GET/POST<br/>REST API"| API
    API -->|"SSE Stream<br/>/api/stream/sensor"| FRONTEND
    
    style ESP32 fill:#e1f5ff
    style GATEWAY fill:#fff3e0
    style BACKEND fill:#f3e5f5
    style FRONTEND fill:#e8f5e9
</div></code></pre>
<h3 id="32-s%C6%A1-%C4%91%E1%BB%93-k%E1%BA%BFt-n%E1%BB%91i-ph%E1%BA%A7n-c%E1%BB%A9ng">3.2. S∆° ƒê·ªì K·∫øt N·ªëi Ph·∫ßn C·ª©ng</h3>
<h4 id="321-esp32-yolouno-board">3.2.1. ESP32 YoloUNO Board</h4>
<pre><code class="language-mermaid"><div class="mermaid">graph LR
    subgraph ESP32["ESP32-S3 YoloUNO Board"]
        MCU["ESP32-S3<br/>Dual Core<br/>WiFi Built-in"]
    end
    
    subgraph SENSORS["üìä Sensors"]
        DHT20["DHT20<br/>I2C Temperature<br/>and Humidity"]
        LIGHT["GL5528<br/>Analog Light<br/>Sensor"]
        PIR["PIR AS312<br/>Digital Motion<br/>Sensor"]
    end
    
    subgraph ACTUATORS["‚öôÔ∏è Actuators"]
        FAN["Fan Motor<br/>PWM Control"]
        LIGHTS["LED Lights<br/>PWM Control"]
    end
    
    MCU -->|"I2C SDA/SCL"| DHT20
    MCU -->|"Analog Pin"| LIGHT
    MCU -->|"Digital Pin"| PIR
    MCU -->|"GPIO2 (PWM Ch0)"| FAN
    MCU -->|"GPIO3 (PWM Ch1)"| LIGHTS
    
    MCU -.->|"WiFi 802.11 b/g/n"| WIFI["üì∂ WiFi Network"]
    
    style ESP32 fill:#bbdefb
    style SENSORS fill:#c8e6c9
    style ACTUATORS fill:#ffccbc
</div></code></pre>
<h4 id="322-chi-ti%E1%BA%BFt-k%E1%BA%BFt-n%E1%BB%91i">3.2.2. Chi Ti·∫øt K·∫øt N·ªëi</h4>
<table>
<thead>
<tr>
<th><strong>Thi·∫øt b·ªã</strong></th>
<th><strong>Lo·∫°i</strong></th>
<th><strong>Giao ti·∫øp</strong></th>
<th><strong>Pin/Channel</strong></th>
<th><strong>Th∆∞ vi·ªán</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>DHT20</td>
<td>Temperature/Humidity</td>
<td>I2C</td>
<td>SDA, SCL</td>
<td>DHT20</td>
</tr>
<tr>
<td>GL5528</td>
<td>Light Sensor</td>
<td>Analog</td>
<td>ADC Pin</td>
<td>lightSensor</td>
</tr>
<tr>
<td>PIR AS312</td>
<td>Motion Sensor</td>
<td>Digital GPIO</td>
<td>Digital Pin</td>
<td>GPIO</td>
</tr>
<tr>
<td>Fan Motor</td>
<td>Actuator</td>
<td>PWM</td>
<td>GPIO 2 (PWM Ch 0)</td>
<td>ledcSetup/ledcWrite</td>
</tr>
<tr>
<td>LED Light</td>
<td>Actuator</td>
<td>PWM</td>
<td>GPIO 3 (PWM Ch 1)</td>
<td>ledcSetup/ledcWrite</td>
</tr>
</tbody>
</table>
<p><strong>PWM Configuration:</strong></p>
<ul>
<li>Frequency: 5000 Hz (5 KHz)</li>
<li>Resolution: 8-bit (0-255)</li>
<li>Levels: 0 (OFF), 1 (33%), 2 (66%), 3 (100%)</li>
</ul>
<h3 id="33-thi%E1%BA%BFt-k%E1%BA%BF-ph%E1%BA%A7n-m%E1%BB%81m">3.3. Thi·∫øt K·∫ø Ph·∫ßn M·ªÅm</h3>
<h4 id="331-lu%E1%BB%93ng-ch%C6%B0%C6%A1ng-tr%C3%ACnh-flowchart">3.3.1. Lu·ªìng Ch∆∞∆°ng Tr√¨nh (Flowchart)</h4>
<pre><code class="language-mermaid"><div class="mermaid">flowchart TD
    START([Start ESP32]) --> INIT[Initialize Serial<br/>and Device Control]
    INIT --> CREATE_TASKS[Create FreeRTOS Tasks]
    
    CREATE_TASKS --> TASK1[temp_humi_monitor]
    CREATE_TASKS --> TASK2[light_sensor_monitor]
    CREATE_TASKS --> TASK3[pir_sensor_monitor]
    CREATE_TASKS --> TASK4[main_server_task]
    CREATE_TASKS --> TASK5[gateway_task]
    
    TASK1 --> T1_READ[Read DHT20<br/>Temp and Humidity]
    T1_READ --> T1_UPDATE[Update Global Variables<br/>glob_temperature<br/>glob_humidity]
    T1_UPDATE --> T1_AUTO{Auto Mode<br/>Enabled?}
    T1_AUTO -->|Yes| T1_CHECK[Check Thresholds]
    T1_CHECK --> T1_CONTROL[Update Fan Level]
    T1_AUTO -->|No| T1_DELAY[Delay]
    T1_CONTROL --> T1_DELAY
    T1_DELAY --> T1_READ
    
    TASK2 --> T2_READ[Read GL5528<br/>Light Sensor]
    T2_READ --> T2_UPDATE[Update glob_light_lux]
    T2_UPDATE --> T2_AUTO{Auto Mode<br/>Enabled?}
    T2_AUTO -->|Yes| T2_CHECK[Check Light Threshold]
    T2_CHECK --> T2_CONTROL[Update Light Level]
    T2_AUTO -->|No| T2_DELAY[Delay]
    T2_CONTROL --> T2_DELAY
    T2_DELAY --> T2_READ
    
    TASK3 --> T3_READ[Read PIR AS312<br/>Motion Sensor]
    T3_READ --> T3_UPDATE[Update glob_pir_detected]
    T3_UPDATE --> T3_DELAY[Delay]
    T3_DELAY --> T3_READ
    
    TASK4 --> T4_WIFI{WiFi<br/>Connected?}
    T4_WIFI -->|No| T4_CONNECT[Connect WiFi]
    T4_CONNECT --> T4_WIFI
    T4_WIFI -->|Yes| T4_WAIT[Wait for Interval]
    T4_WAIT --> T4_READ[Read All Sensor Data]
    T4_READ --> T4_MQTT[Send via MQTT]
    T4_MQTT --> T4_WAIT
    
    TASK5 --> T5_WIFI{WiFi<br/>Connected?}
    T5_WIFI -->|No| T5_DELAY_NO[Delay and Retry]
    T5_DELAY_NO --> T5_WIFI
    T5_WIFI -->|Yes| T5_CONNECT[Connect to<br/>MQTT Broker]
    T5_CONNECT --> T5_SUB[Subscribe to<br/>yolouno/command<br/>yolouno/wifi]
    T5_SUB --> T5_LISTEN[Listen for Commands]
    T5_LISTEN --> T5_MSG{Message<br/>Received?}
    T5_MSG -->|Yes| T5_PARSE[Parse JSON]
    T5_PARSE --> T5_CMD{Command<br/>Type?}
    T5_CMD -->|FAN| T5_FAN[Set Fan Level]
    T5_CMD -->|LIGHT| T5_LIGHT[Set Light Level]
    T5_CMD -->|INTERVAL| T5_INT[Update Send Interval]
    T5_CMD -->|WIFI| T5_WIFI_CFG[Update WiFi Config]
    T5_FAN --> T5_LISTEN
    T5_LIGHT --> T5_LISTEN
    T5_INT --> T5_LISTEN
    T5_WIFI_CFG --> T5_RECONNECT[Reconnect WiFi]
    T5_RECONNECT --> T5_WIFI
    T5_MSG -->|No| T5_LISTEN
    
    style START fill:#4caf50
    style CREATE_TASKS fill:#2196f3
    style T1_READ fill:#ff9800
    style T2_READ fill:#ff9800
    style T3_READ fill:#ff9800
    style T4_READ fill:#ff9800
    style T1_CONTROL fill:#9c27b0
    style T2_CONTROL fill:#9c27b0
</div></code></pre>
<h4 id="332-state-diagram---gateway-mqtt-bridge">3.3.2. State Diagram - Gateway MQTT Bridge</h4>
<pre><code class="language-mermaid"><div class="mermaid">stateDiagram-v2
    [*] --> Starting
    Starting --> BrokerStarting: Start MQTT Broker Thread
    BrokerStarting --> SubscriberConnecting: Broker Ready (5s delay)
    SubscriberConnecting --> PublisherConnecting: Subscriber Connected
    PublisherConnecting --> SSEConnecting: Publisher Connected
    SSEConnecting --> Running: SSE Stream Connected
    
    state Running {
        [*] --> Listening
        Listening --> SensorReceived: MQTT topic sensor
        SensorReceived --> ForwardingToBackend: Parse JSON
        ForwardingToBackend --> Listening: HTTP POST sensor data
        
        Listening --> CommandReceived: SSE command event
        CommandReceived --> PublishingCommand: Parse Command
        PublishingCommand --> Listening: MQTT Publish command
        
        Listening --> WiFiReceived: SSE wifi event
        WiFiReceived --> PublishingWiFi: Parse WiFi Config
        PublishingWiFi --> Listening: MQTT Publish wifi config
    }
    
    Running --> Error: Connection Lost
    Error --> Reconnecting: Retry Connection
    Reconnecting --> Running: Connected
    Reconnecting --> Error: Failed (retry in 5s)
</div></code></pre>
<h3 id="34-m%C3%B4-t%E1%BA%A3-ch%E1%BB%A9c-n%C4%83ng-t%E1%BB%ABng-module">3.4. M√¥ T·∫£ Ch·ª©c NƒÉng T·ª´ng Module</h3>
<h4 id="341-esp32-firmware-modules">3.4.1. ESP32 Firmware Modules</h4>
<table>
<thead>
<tr>
<th><strong>Module</strong></th>
<th><strong>File</strong></th>
<th><strong>Ch·ª©c nƒÉng</strong></th>
<th><strong>FreeRTOS Task</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Temperature and Humidity Monitor</strong></td>
<td><code>temp_humi_monitor.cpp</code></td>
<td>ƒê·ªçc d·ªØ li·ªáu t·ª´ c·∫£m bi·∫øn DHT20 qua I2C, c·∫≠p nh·∫≠t bi·∫øn to√†n c·ª•c <code>glob_temperature</code> v√† <code>glob_humidity</code>. Ki·ªÉm tra auto mode ƒë·ªÉ t·ª± ƒë·ªông ƒëi·ªÅu khi·ªÉn qu·∫°t.</td>
<td><code>temp_humi_monitor</code></td>
</tr>
<tr>
<td><strong>Light Sensor Monitor</strong></td>
<td><code>light_sensor.cpp</code></td>
<td>ƒê·ªçc c∆∞·ªùng ƒë·ªô √°nh s√°ng t·ª´ GL5528 (analog), chuy·ªÉn ƒë·ªïi sang lux, c·∫≠p nh·∫≠t <code>glob_light_lux</code>. Ki·ªÉm tra auto mode ƒë·ªÉ t·ª± ƒë·ªông ƒëi·ªÅu khi·ªÉn ƒë√®n.</td>
<td><code>light_sensor_monitor</code></td>
</tr>
<tr>
<td><strong>PIR Motion Sensor</strong></td>
<td><code>pir_sensor.cpp</code></td>
<td>ƒê·ªçc t√≠n hi·ªáu chuy·ªÉn ƒë·ªông t·ª´ PIR AS312 (digital), c·∫≠p nh·∫≠t <code>glob_pir_detected</code> ƒë·ªÉ ph√°t hi·ªán c√≥ ng∆∞·ªùi trong ph√≤ng.</td>
<td><code>pir_sensor_monitor</code></td>
</tr>
<tr>
<td><strong>Device Control</strong></td>
<td><code>device_control.cpp</code></td>
<td>ƒêi·ªÅu khi·ªÉn qu·∫°t v√† ƒë√®n qua PWM (GPIO 2 v√† 3). H·ªó tr·ª£ 4 m·ª©c: OFF (0), Low (1), Medium (2), High (3). Qu·∫£n l√Ω ch·∫ø ƒë·ªô Auto/Manual.</td>
<td>N/A (called by other tasks)</td>
</tr>
<tr>
<td><strong>Main Server Task</strong></td>
<td><code>mainserver.cpp</code></td>
<td>K·∫øt n·ªëi WiFi, ƒë·ªãnh k·ª≥ g·ª≠i d·ªØ li·ªáu c·∫£m bi·∫øn qua MQTT theo interval (m·∫∑c ƒë·ªãnh 5s).</td>
<td><code>main_server_task</code></td>
</tr>
<tr>
<td><strong>Gateway Task</strong></td>
<td><code>gateway.cpp</code></td>
<td>K·∫øt n·ªëi MQTT broker (Python Gateway), subscribe c√°c topic nh·∫≠n l·ªánh (<code>yolouno/command</code>, <code>yolouno/wifi</code>), x·ª≠ l√Ω l·ªánh ƒëi·ªÅu khi·ªÉn t·ª´ backend.</td>
<td><code>gateway_task</code></td>
</tr>
</tbody>
</table>
<h4 id="342-python-mqtt-gateway">3.4.2. Python MQTT Gateway</h4>
<table>
<thead>
<tr>
<th><strong>Component</strong></th>
<th><strong>Ch·ª©c nƒÉng</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>MQTT Broker</strong></td>
<td>Ch·∫°y embedded MQTT broker (hbmqtt) tr√™n port 1883, cho ph√©p ESP32 v√† c√°c client k·∫øt n·ªëi.</td>
</tr>
<tr>
<td><strong>MQTT Subscriber</strong></td>
<td>Subscribe topic <code>yolouno/sensor</code>, nh·∫≠n d·ªØ li·ªáu c·∫£m bi·∫øn t·ª´ ESP32, forward ƒë·∫øn Backend qua HTTP POST <code>/api/iot/sensor</code>.</td>
</tr>
<tr>
<td><strong>MQTT Publisher</strong></td>
<td>Publish l·ªánh ƒëi·ªÅu khi·ªÉn ƒë·∫øn ESP32 qua topics <code>yolouno/command</code> (FAN/LIGHT/INTERVAL) v√† <code>yolouno/wifi</code> (WiFi config).</td>
</tr>
<tr>
<td><strong>Backend SSE Listener</strong></td>
<td>K·∫øt n·ªëi SSE stream <code>/api/iot/commandStream</code> t·ª´ Backend, nh·∫≠n l·ªánh t·ª´ Web UI, chuy·ªÉn th√†nh MQTT message g·ª≠i ESP32.</td>
</tr>
</tbody>
</table>
<h4 id="343-backend-server-nodejs">3.4.3. Backend Server (Node.js)</h4>
<table>
<thead>
<tr>
<th><strong>Module</strong></th>
<th><strong>File</strong></th>
<th><strong>Ch·ª©c nƒÉng</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Server</strong></td>
<td><code>server.js</code></td>
<td>Kh·ªüi t·∫°o Express server, k·∫øt n·ªëi MongoDB, c·∫•u h√¨nh CORS v√† middleware.</td>
</tr>
<tr>
<td><strong>Router</strong></td>
<td><code>router.js</code></td>
<td>ƒê·ªãnh nghƒ©a c√°c API routes cho sensor data, device control, action history, SSE streaming.</td>
</tr>
<tr>
<td><strong>Controller</strong></td>
<td><code>controller.js</code></td>
<td>X·ª≠ l√Ω logic nghi·ªáp v·ª•: qu·∫£n l√Ω thi·∫øt b·ªã (fan, light), auto mode, l∆∞u sensor data v√†o DB, x·ª≠ l√Ω action history, streaming SSE.</td>
</tr>
<tr>
<td><strong>Database</strong></td>
<td>MongoDB</td>
<td>Collections: <code>users</code>, <code>sensorData</code>, <code>actionHistory</code>. L∆∞u tr·ªØ d·ªØ li·ªáu l·ªãch s·ª≠ c·∫£m bi·∫øn, h√†nh ƒë·ªông ƒëi·ªÅu khi·ªÉn.</td>
</tr>
</tbody>
</table>
<p><strong>Key Functions:</strong></p>
<ul>
<li><code>updateSensorData</code>: Nh·∫≠n d·ªØ li·ªáu t·ª´ Gateway, broadcast qua SSE, l∆∞u v√†o DB, ki·ªÉm tra auto mode ƒë·ªÉ ƒëi·ªÅu khi·ªÉn thi·∫øt b·ªã.</li>
<li><code>commandStream</code>: SSE endpoint ƒë·ªÉ Gateway subscribe, nh·∫≠n l·ªánh ƒëi·ªÅu khi·ªÉn t·ª´ Web UI.</li>
<li><code>streamSensor</code>: SSE endpoint ƒë·ªÉ Frontend nh·∫≠n real-time sensor data.</li>
<li><code>configureWifi</code>, <code>configureInterval</code>: API ƒë·ªÉ c·∫•u h√¨nh WiFi v√† interval g·ª≠i d·ªØ li·ªáu t·ª´ Web UI.</li>
</ul>
<h4 id="344-web-frontend-react">3.4.4. Web Frontend (React)</h4>
<table>
<thead>
<tr>
<th><strong>Component</strong></th>
<th><strong>Ch·ª©c nƒÉng</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Dashboard</strong></td>
<td>Hi·ªÉn th·ªã real-time charts (temperature, humidity, light) s·ª≠ d·ª•ng Chart.js. K·∫øt n·ªëi SSE <code>/api/stream/sensor</code> ƒë·ªÉ nh·∫≠n d·ªØ li·ªáu real-time.</td>
</tr>
<tr>
<td><strong>Device Control Panel</strong></td>
<td>ƒêi·ªÅu khi·ªÉn qu·∫°t v√† ƒë√®n (ON/OFF, level 1-3), b·∫≠t/t·∫Øt auto mode, g·ª≠i l·ªánh qua API.</td>
</tr>
<tr>
<td><strong>Configuration</strong></td>
<td>C·∫•u h√¨nh WiFi (SSID, password), data send interval, g·ª≠i l·ªánh qua API <code>/api/config/wifi</code> v√† <code>/api/config/interval</code>.</td>
</tr>
<tr>
<td><strong>Action History</strong></td>
<td>Xem l·ªãch s·ª≠ h√†nh ƒë·ªông ƒëi·ªÅu khi·ªÉn v·ªõi ph√¢n trang, l·ªçc theo th·ªùi gian.</td>
</tr>
</tbody>
</table>
<p><strong>Technology Stack:</strong></p>
<ul>
<li>React 19.1 v·ªõi React Router 7.7</li>
<li>Chart.js + react-chartjs-2 cho visualization</li>
<li>Tailwind CSS 4.1 cho styling</li>
<li>Lucide React icons</li>
<li>SSE client ƒë·ªÉ nh·∫≠n real-time updates</li>
</ul>
<h3 id="35-giao-th%E1%BB%A9c-truy%E1%BB%81n-d%E1%BB%AF-li%E1%BB%87u">3.5. Giao Th·ª©c Truy·ªÅn D·ªØ Li·ªáu</h3>
<h4 id="351-mqtt-protocol">3.5.1. MQTT Protocol</h4>
<pre><code class="language-mermaid"><div class="mermaid">sequenceDiagram
    participant ESP32
    participant Gateway as MQTT Gateway<br/>(Python)
    participant Backend as Backend Server<br/>(Node.js)
    
    Note over ESP32,Gateway: MQTT Communication (Port 1883)
    
    ESP32->>Gateway: CONNECT (MQTT v3.11)
    Gateway-->>ESP32: CONNACK
    
    ESP32->>Gateway: SUBSCRIBE yolouno/command
    ESP32->>Gateway: SUBSCRIBE yolouno/wifi
    Gateway-->>ESP32: SUBACK
    
    loop Every Interval (default 5s)
        ESP32->>Gateway: PUBLISH yolouno/sensor<br/>{"TEMP":25.5,"HUMI":60,"LIGHT":450,"PRES":1}
        Gateway->>Backend: HTTP POST /api/iot/sensor<br/>{"TEMP":25.5,"HUMI":60,"LIGHT":450,"PRES":1}
        Backend-->>Gateway: 200 OK
    end
    
    Note over Gateway,Backend: SSE Stream for Commands
    Gateway->>Backend: GET /api/iot/commandStream<br/>(SSE Connection)
    
    Backend-->>Gateway: event: command<br/>data: {"device":"FAN","value":"MANUAL2"}
    Gateway->>ESP32: PUBLISH yolouno/command<br/>{"device":"FAN","value":"MANUAL2"}
    
    Backend-->>Gateway: event: wifi<br/>data: {"device":"MySSID","value":"password123"}
    Gateway->>ESP32: PUBLISH yolouno/wifi<br/>{"ssid":"MySSID","password":"password123"}
</div></code></pre>
<p><strong>MQTT Topics:</strong></p>
<table>
<thead>
<tr>
<th><strong>Topic</strong></th>
<th><strong>Direction</strong></th>
<th><strong>QoS</strong></th>
<th><strong>Payload Format</strong></th>
<th><strong>Purpose</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>yolouno/sensor</code></td>
<td>ESP32 ‚Üí Gateway</td>
<td>0</td>
<td><code>{&quot;TEMP&quot;:float,&quot;HUMI&quot;:float,&quot;LIGHT&quot;:float,&quot;PRES&quot;:int}</code></td>
<td>Sensor data publishing</td>
</tr>
<tr>
<td><code>yolouno/command</code></td>
<td>Gateway ‚Üí ESP32</td>
<td>0</td>
<td><code>{&quot;device&quot;:&quot;FAN\|LIGHT\|INTERVAL&quot;,&quot;value&quot;:&quot;MANUAL0\|MANUAL1\|MANUAL2\|MANUAL3\|AUTO&quot;}</code></td>
<td>Device control commands</td>
</tr>
<tr>
<td><code>yolouno/wifi</code></td>
<td>Gateway ‚Üí ESP32</td>
<td>0</td>
<td><code>{&quot;ssid&quot;:&quot;string&quot;,&quot;password&quot;:&quot;string&quot;}</code></td>
<td>WiFi configuration</td>
</tr>
</tbody>
</table>
<h4 id="352-httprest-api">3.5.2. HTTP/REST API</h4>
<p><strong>Backend API Endpoints:</strong></p>
<table>
<thead>
<tr>
<th><strong>Method</strong></th>
<th><strong>Endpoint</strong></th>
<th><strong>Payload</strong></th>
<th><strong>Response</strong></th>
<th><strong>Purpose</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>POST</td>
<td><code>/api/iot/sensor</code></td>
<td><code>{&quot;TEMP&quot;:25.5,&quot;HUMI&quot;:60,&quot;LIGHT&quot;:450,&quot;PRES&quot;:1}</code></td>
<td><code>200 OK</code></td>
<td>Gateway forwards sensor data</td>
</tr>
<tr>
<td>GET</td>
<td><code>/api/iot/commandStream</code></td>
<td>N/A</td>
<td>SSE Stream</td>
<td>Gateway subscribes for commands</td>
</tr>
<tr>
<td>GET</td>
<td><code>/api/stream/sensor</code></td>
<td>N/A</td>
<td>SSE Stream</td>
<td>Frontend subscribes for real-time sensor data</td>
</tr>
<tr>
<td>POST</td>
<td><code>/api/config/wifi</code></td>
<td><code>{&quot;ssid&quot;:&quot;MyWiFi&quot;,&quot;password&quot;:&quot;pass123&quot;}</code></td>
<td><code>{&quot;message&quot;:&quot;WiFi configuration sent&quot;}</code></td>
<td>Configure ESP32 WiFi</td>
</tr>
<tr>
<td>POST</td>
<td><code>/api/config/interval</code></td>
<td><code>{&quot;interval&quot;:5}</code></td>
<td><code>{&quot;message&quot;:&quot;Interval configuration sent&quot;}</code></td>
<td>Set sensor data send interval (seconds)</td>
</tr>
<tr>
<td>POST</td>
<td><code>/api/device/:name/toggle</code></td>
<td>N/A</td>
<td>Device status JSON</td>
<td>Toggle device ON/OFF</td>
</tr>
<tr>
<td>POST</td>
<td><code>/api/device/:name/auto</code></td>
<td>N/A</td>
<td>Device status JSON</td>
<td>Toggle auto mode</td>
</tr>
<tr>
<td>POST</td>
<td><code>/api/device/:name/level</code></td>
<td><code>{&quot;level&quot;:1-3}</code></td>
<td>Device status JSON</td>
<td>Set device level</td>
</tr>
<tr>
<td>GET</td>
<td><code>/api/sensor/temperature?duration=5</code></td>
<td>N/A</td>
<td><code>{&quot;temperatures&quot;:[...]}</code></td>
<td>Get temperature history</td>
</tr>
<tr>
<td>GET</td>
<td><code>/api/sensor/humidity?duration=5</code></td>
<td>N/A</td>
<td><code>{&quot;humidities&quot;:[...]}</code></td>
<td>Get humidity history</td>
</tr>
<tr>
<td>GET</td>
<td><code>/api/sensor/light?duration=5</code></td>
<td>N/A</td>
<td><code>{&quot;lightLevels&quot;:[...]}</code></td>
<td>Get light level history</td>
</tr>
<tr>
<td>GET</td>
<td><code>/api/history/action?page=1&amp;limit=20</code></td>
<td>N/A</td>
<td><code>{&quot;totalPages&quot;:N,&quot;actions&quot;:[...]}</code></td>
<td>Get action history with pagination</td>
</tr>
</tbody>
</table>
<h4 id="353-server-sent-events-sse">3.5.3. Server-Sent Events (SSE)</h4>
<p><strong>SSE Streams:</strong></p>
<table>
<thead>
<tr>
<th><strong>Endpoint</strong></th>
<th><strong>Event Types</strong></th>
<th><strong>Data Format</strong></th>
<th><strong>Client</strong></th>
<th><strong>Purpose</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/api/stream/sensor</code></td>
<td><code>event: sensor</code></td>
<td><code>{&quot;TEMP&quot;:25.5,&quot;HUMI&quot;:60,&quot;LIGHT&quot;:450,&quot;PRES&quot;:1}</code></td>
<td>Frontend</td>
<td>Real-time sensor data for dashboard charts</td>
</tr>
<tr>
<td><code>/api/stream/status</code></td>
<td><code>event: status</code></td>
<td><code>{&quot;fan&quot;:true,&quot;light&quot;:false}</code></td>
<td>Frontend</td>
<td>Real-time device status updates</td>
</tr>
<tr>
<td><code>/api/iot/commandStream</code></td>
<td><code>event: command</code><br/><code>event: wifi</code><br/><code>event: interval</code></td>
<td><code>{&quot;device&quot;:&quot;FAN&quot;,&quot;value&quot;:&quot;MANUAL2&quot;}</code><br/><code>{&quot;device&quot;:&quot;SSID&quot;,&quot;value&quot;:&quot;password&quot;}</code><br/><code>{&quot;type&quot;:&quot;interval&quot;,&quot;value&quot;:&quot;5&quot;}</code></td>
<td>Gateway</td>
<td>Commands from Backend to Gateway for ESP32</td>
</tr>
</tbody>
</table>
<p><strong>SSE Connection Flow:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">// Frontend SSE Client (JavaScript)</span>
<span class="hljs-keyword">const</span> eventSource = <span class="hljs-keyword">new</span> EventSource(<span class="hljs-string">'http://localhost:3000/api/stream/sensor'</span>);
eventSource.addEventListener(<span class="hljs-string">'sensor'</span>, (event) =&gt; {
  <span class="hljs-keyword">const</span> data = <span class="hljs-built_in">JSON</span>.parse(event.data);
  updateChart(data);
});
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment"># Gateway SSE Client (Python)</span>
<span class="hljs-keyword">from</span> sseclient <span class="hljs-keyword">import</span> SSEClient
response = requests.get(<span class="hljs-string">'http://localhost:3000/api/iot/commandStream'</span>, stream=<span class="hljs-literal">True</span>)
client = SSEClient(response)
<span class="hljs-keyword">for</span> event <span class="hljs-keyword">in</span> client.events():
    <span class="hljs-keyword">if</span> event.event == <span class="hljs-string">'command'</span>:
        data = json.loads(event.data)
        publish_command_to_esp32(data)
</div></code></pre>
<h3 id="36-thi%E1%BA%BFt-k%E1%BA%BF-giao-di%E1%BB%87n-web-dashboard">3.6. Thi·∫øt K·∫ø Giao Di·ªán (Web Dashboard)</h3>
<h4 id="361-dashboard-layout">3.6.1. Dashboard Layout</h4>
<pre><code class="language-mermaid"><div class="mermaid">graph LR
    subgraph DASHBOARD["üìä Smart Classroom Dashboard"]
        HEADER["üéØ Header"]
        
        subgraph ROW1["Real-time Sensors"]
            TEMP["üå°Ô∏è Temp: 25.5¬∞C"]
            HUMI["üíß Humi: 60%"]
            LIGHT["üí° Light: 450lux"]
            PIR["üë§ Motion"]
        end
        
        subgraph ROW2["Device Control"]
            FAN["üåÄ Fan<br/>Level 0-3<br/>Auto"]
            LIGHT_C["üí° Light<br/>Level 0-3<br/>Auto"]
        end
        
        subgraph ROW3["Configuration & History"]
            WIFI["üì∂ WiFi"]
            INTERVAL["‚è±Ô∏è Interval"]
            HISTORY["üìú History"]
        end
        
        HEADER --> ROW1
        ROW1 --> ROW2
        ROW2 --> ROW3
    end
    
    style DASHBOARD fill:#e3f2fd
    style ROW1 fill:#c8e6c9
    style ROW2 fill:#fff9c4
    style ROW3 fill:#ffe0b2
</div></code></pre>
<p><strong>Dashboard Layout Details:</strong></p>
<ul>
<li><strong>Header</strong>: Smart Classroom IoT Monitor title with system status</li>
<li><strong>Real-time Sensors Row</strong>: Temperature (25.5¬∞C), Humidity (60%), Light (450 lux), Motion (Yes/No) - Each with line charts showing last 5 minutes of data</li>
<li><strong>Device Control Row</strong>: Fan Control (Toggle ON/OFF, Level 0-3, Auto Mode), Light Control (Toggle ON/OFF, Level 0-3, Auto Mode)</li>
<li><strong>Configuration & History Row</strong>: WiFi Settings (SSID/Password inputs), Data Interval (seconds), Action History (Time | Action | Trigger with pagination)</li>
</ul>
<h4 id="362-ui-components">3.6.2. UI Components</h4>
<p><strong>Dashboard Features:</strong></p>
<ul>
<li><strong>Real-time Charts</strong>: Line charts hi·ªÉn th·ªã temperature, humidity, light level theo th·ªùi gian, t·ª± ƒë·ªông c·∫≠p nh·∫≠t qua SSE</li>
<li><strong>Device Cards</strong>: Hi·ªÉn th·ªã tr·∫°ng th√°i hi·ªán t·∫°i c·ªßa Fan v√† Light v·ªõi toggle switches v√† level sliders</li>
<li><strong>Auto Mode Indicators</strong>: Bi·ªÉu t∆∞·ª£ng hi·ªÉn th·ªã khi thi·∫øt b·ªã ·ªü ch·∫ø ƒë·ªô Auto</li>
<li><strong>Configuration Forms</strong>: Form nh·∫≠p WiFi credentials v√† data send interval</li>
<li><strong>Action History Table</strong>: B·∫£ng ph√¢n trang hi·ªÉn th·ªã l·ªãch s·ª≠ ƒëi·ªÅu khi·ªÉn v·ªõi filter theo th·ªùi gian</li>
<li><strong>Responsive Design</strong>: S·ª≠ d·ª•ng Tailwind CSS ƒë·ªÉ responsive tr√™n mobile v√† desktop</li>
</ul>
<h4 id="363-data-flow---frontend">3.6.3. Data Flow - Frontend</h4>
<pre><code class="language-mermaid"><div class="mermaid">sequenceDiagram
    participant User
    participant UI as React Frontend
    participant SSE as SSE Stream
    participant API as Backend API
    
    User->>UI: Open Dashboard
    UI->>SSE: Connect to /api/stream/sensor
    SSE-->>UI: event: sensor (real-time data)
    UI->>UI: Update Charts
    
    loop Every sensor update
        SSE-->>UI: event: sensor<br/>{"TEMP":25.5,"HUMI":60,"LIGHT":450}
        UI->>UI: Parse data and Update Chart.js
    end
    
    User->>UI: Toggle Fan ON
    UI->>API: POST /api/device/fan/toggle
    API-->>UI: 200 OK {"isActive":true,"speed":2}
    UI->>UI: Update UI State
    
    User->>UI: Set Light Level 3
    UI->>API: POST /api/device/light/level<br/>{"level":3}
    API-->>UI: 200 OK {"isActive":true,"brightness":3}
    UI->>UI: Update UI State
    
    User->>UI: Configure WiFi
    UI->>API: POST /api/config/wifi<br/>{"ssid":"Home","password":"pass123"}
    API->>Gateway: SSE event: wifi
    Gateway->>ESP32: MQTT yolouno/wifi
    API-->>UI: 200 OK {"message":"WiFi config sent"}
    UI->>UI: Show Success Message
</div></code></pre>
<hr>


</body>
</html>
